# Asmit ERPNext Magic Link

A standalone Frappe app to generate secure, one-time-use magic login links for ERPNext and external applications.

## Features

- **Internal Login**: Log users directly into the ERPNext desk or website.
- **External Login (Headless)**: Authenticate users on external apps (e.g., Next.js, React) using JWT.
- **Mobile Number Support**: Automatically update or create user contacts with mobile numbers.
- **Secure**: Single-use tokens with configurable expiry (default 30 mins).
- **Standalone**: No external dependencies required.

## Installation

1.  Get the app
    ```bash
    bench get-app https://github.com/asmitonweb/asmit_erpnext_magiclink
    ```

2.  Install the app
    ```bash
    bench --site [site-name] install-app asmit_erpnext_magiclink
    ```

## API Usage

### 1. Generate Magic Link

**Endpoint**: `/api/method/asmit_erpnext_magiclink.api.generate_magic_link`
**Method**: `POST`

**Parameters**:
| Parameter | Type | Required | Description |
| :--- | :--- | :--- | :--- |
| `email` | string | Yes | User's email address. |
| `name` | string | No | Name to create user if not exists. |
| `redirect_to` | string | No | External URL to redirect to (for headless mode). |
| `mobile_number` | string | No | Mobile number to save in User Contact. |

**Example (Internal Login)**:
```bash
curl -X POST https://your-site.com/api/method/asmit_erpnext_magiclink.api.generate_magic_link \
    -d "email=user@example.com"
```
**Returns**: `https://your-site.com/api/method/asmit_erpnext_magiclink.api.login_via_token?token=...`

**Example (External Login)**:
```bash
curl -X POST https://your-site.com/api/method/asmit_erpnext_magiclink.api.generate_magic_link \
    -d "email=user@example.com" \
    -d "redirect_to=https://myapp.com/login" \
    -d "mobile_number=1234567890"
```
**Returns**: `https://myapp.com/login?token=...`

### 2. Verify Token (External App)

**Endpoint**: `/api/method/asmit_erpnext_magiclink.api.verify_token`
**Method**: `GET`

**Parameters**:
| Parameter | Type | Required | Description |
| :--- | :--- | :--- | :--- |
| `token` | string | Yes | The token received in the URL. |

**Response**:
```json
{
    "status": "success",
    "user": "user@example.com",
    "email": "user@example.com",
    "full_name": "User Name",
    "access_token": "eyJhbGciOiJIUzI1NiIsIn...",
    "token_type": "X-Authorization"
}
```

## Configuration

### JWT Secret (Optional)
The app automatically uses your site's `encryption_key` (generated by Frappe) to sign tokens. This is secure by default.

If you want to use a specific secret key for JWTs (e.g., to share with another app), you can override it in `site_config.json`:

```json
{
    "jwt_secret_key": "your-custom-secret-key"
}
```

## Production Deployment

### 1. CORS Configuration
If your frontend (e.g., `https://app.yoursite.com`) and backend (e.g., `https://api.yoursite.com`) are on different domains, you **must** enable CORS.

**Security Tip**: In production, replace `*` with your actual frontend domain to restrict access.

In `site_config.json`:
```json
{
    "allow_cors": "https://app.yoursite.com"
}
```

### 2. JWT Secret
Ensure your site has a secure `encryption_key` (generated automatically by Frappe) or set a custom `jwt_secret_key` in `site_config.json`.

## License

MIT
